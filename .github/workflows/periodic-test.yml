name: Periodic Tests

on:
  # schedule:
  #   - cron: "*/10 * * * *"
  workflow_dispatch:
    inputs:
      dev:
        description: "Only testing the workflow"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    # only run on changes to periodic-test dir
    paths:
      - "tests/periodic-test/**"
      - ".github/workflows/periodic-test.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

permissions:
  contents: read

jobs:
  changes:
    name: Check
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        test-command:
          - command: "tests/periodic-test/internet-works.ts"
            name: "internet connectivity inside of sandbox"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse .tool-versions
        uses: wistia/parse-tool-versions@v2.1.1
        with:
          filename: ".tool-versions"
          uppercase: "true"
          prefix: "tool_version_"

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "${{ env.TOOL_VERSION_BUN }}"

      - name: Cache Bun dependencies (periodic-test)
        id: bun-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            tests/periodic-test/node_modules
          key: ${{ runner.os }}-bun-periodic-${{ hashFiles('tests/periodic-test/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-periodic-

      - name: Install dependencies (tests/periodic-test)
        working-directory: tests/periodic-test
        run: bun install --frozen-lockfile

      - name: ${{ matrix.test-command.name }}
        run: bun run ${{ matrix.test-command.command }}
        env:
          MORU_API_KEY: ${{ secrets.MORU_API_KEY }}
          MORU_ACCESS_TOKEN: ${{ secrets.MORU_ACCESS_TOKEN }}
          MORU_DOMAIN: moru.io
