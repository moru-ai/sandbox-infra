syntax = "proto3";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/moru-ai/sandbox-infra/packages/orchestrator";

message SandboxConfig {
  // Data required for creating a new sandbox.
  string template_id = 1;
  string build_id = 2;

  string kernel_version = 3;
  string firecracker_version = 4;

  bool huge_pages = 5;

  string sandbox_id = 6;
  map<string, string> env_vars = 7;

  // Metadata about the sandbox.
  map<string, string> metadata = 8;
  optional string alias = 9;
  string envd_version = 10;

  int64 vcpu = 11;
  int64 ram_mb = 12;

  string team_id = 13;
  // Maximum length of the sandbox in Hours.
  int64 max_sandbox_length = 14;

  int64 total_disk_size_mb = 15;

  bool snapshot = 16;
  string base_template_id = 17;

  bool auto_pause = 18;

  optional string envd_access_token = 19;
  string execution_id = 20;

  // Whether the sandbox should have access to the internet.
  // This is optional only for backwards compatibility.
  // After migration, the optional keyword can be removed.
  optional bool allow_internet_access = 21;

  optional SandboxNetworkConfig network = 22;

  // Volume configuration for persistent storage.
  optional VolumeConfig volume = 23;
}

// VolumeConfig contains configuration for attaching a volume to a sandbox.
message VolumeConfig {
  // The volume ID (e.g., "vol_abc123").
  string volume_id = 1;

  // The mount path inside the sandbox (e.g., "/workspace").
  string mount_path = 2;

  // Redis database number for JuiceFS metadata key prefix.
  int32 redis_db = 3;

  // GCS bucket name for volume data storage.
  string gcs_bucket = 4;
}

message SandboxNetworkConfig {
  optional SandboxNetworkEgressConfig egress = 1;
  optional SandboxNetworkIngressConfig ingress = 2;
}

message SandboxNetworkEgressConfig {
  repeated string allowed_cidrs = 1;
  repeated string denied_cidrs = 2;
  
  repeated string allowed_domains = 3;
}

message SandboxNetworkIngressConfig {
  optional string traffic_access_token = 1;
  optional string mask_request_host = 2;
}

message SandboxCreateRequest {
  SandboxConfig sandbox = 1;

  google.protobuf.Timestamp start_time = 2;
  google.protobuf.Timestamp end_time = 3;
}

message SandboxCreateResponse {
  string client_id = 1;
}

message SandboxUpdateRequest {
  string sandbox_id = 1;

  google.protobuf.Timestamp end_time = 2;
}

message SandboxDeleteRequest {
  string sandbox_id = 1;
  // Reason for killing the sandbox. Optional for backwards compatibility.
  // Values: "killed" (user-initiated), "timeout" (expired), "error", "shutdown"
  optional string end_reason = 2;
}

message SandboxPauseRequest {
  string sandbox_id = 1;
  string template_id = 2;
  string build_id = 3;
}

message RunningSandbox {
  SandboxConfig config = 1;
  string client_id = 2;

  google.protobuf.Timestamp start_time = 3;
  google.protobuf.Timestamp end_time = 4;
}

message SandboxListResponse {
  repeated RunningSandbox sandboxes = 1;
}

message CachedBuildInfo {
  string build_id = 1;
  google.protobuf.Timestamp expiration_time = 2;
}

message SandboxListCachedBuildsResponse {
  repeated CachedBuildInfo builds = 1;
}

service SandboxService {
  rpc Create(SandboxCreateRequest) returns (SandboxCreateResponse);
  rpc Update(SandboxUpdateRequest) returns (google.protobuf.Empty);
  rpc List(google.protobuf.Empty) returns (SandboxListResponse);
  rpc Delete(SandboxDeleteRequest) returns (google.protobuf.Empty);
  rpc Pause(SandboxPauseRequest) returns (google.protobuf.Empty);

  rpc ListCachedBuilds(google.protobuf.Empty) returns (SandboxListCachedBuildsResponse);
}
